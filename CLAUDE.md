# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Build & Dev Commands

```bash
npm run tauri dev      # Full app dev mode (Vite + Rust hot reload)
npm run tauri build    # Production build (runs vue-tsc --noEmit first)
npm run build          # Frontend only: type-check + vite build
cargo check            # Type-check Rust code (run from src-tauri/)
vue-tsc --noEmit       # Type-check frontend
```

## Architecture

Desklist is a Windows desktop memo/reminder app built with Tauri 2 + Vue 3 + TypeScript. It runs as a frameless, transparent, always-on-bottom window (360×520) with Acrylic glass effect that minimizes to the system tray instead of closing. Bundle target is NSIS (Windows only).

### Data flow split

- **Frontend (Vue)** handles all event CRUD directly via `@tauri-apps/plugin-sql` JavaScript API — no Tauri IPC commands for data operations.
- **Rust backend** handles system integration only: reminder scheduler, tray icon, single-instance enforcement, close-to-tray behavior.

### Reminder scheduler (Rust)

`scheduler.rs` runs a background async loop polling every 30 seconds. It accesses the same SQLite database by reaching into `tauri_plugin_sql::DbInstances` state and pattern-matching `DbPool::Sqlite(pool)` to get the raw sqlx pool. This avoids opening a second DB connection.

### Database

SQLite via `tauri-plugin-sql`, database URI: `sqlite:desklist.db`. Migration SQL lives in `src-tauri/migrations/001_init.sql`, loaded via `include_str!` in `db.rs` and registered through `tauri_plugin_sql::Builder::add_migrations()`.

Two tables: `events` (main data) and `reminder_queue` (scheduled notification triggers with `fired` flag). Reminder queue rows are generated by the frontend composable when creating/updating events. Indexes exist on `events(event_time)`, `events(completed)`, `reminder_queue(fire_at)`, and `reminder_queue(fired, fire_at)`.

**SQL parameterization gotcha**: Frontend plugin-sql uses `$1, $2` positional params. Rust sqlx uses `?` placeholders. Don't mix them up when writing queries.

### DB connection pattern

`useEvents()` calls `Database.load('sqlite:desklist.db')` on every operation — there is no singleton or cached connection. Both `App.vue` and `EventList.vue` instantiate their own `useEvents()`.

### Close-to-tray (two layers)

`TitleBar.vue` intercepts minimize/close button clicks and calls `appWindow.hide()` directly. The Rust `on_window_event(CloseRequested)` handler in `lib.rs` is a second layer that catches OS-level close (Alt+F4, taskbar right-click close) and prevents the window from actually closing.

### Frontend structure

- `composables/useEvents.ts` — all DB queries and business logic (CRUD, filter queries, recurring event generation, reminder queue management)
- `components/EventList.vue` — main view with tab filtering (今天/即将/已完成/全部)
- `components/EventForm.vue` — slide-in create/edit panel
- `components/TitleBar.vue` — custom draggable title bar using `data-tauri-drag-region`
- `types/index.ts` — `DeskEvent`, `ReminderRecord`, `FilterTab` interfaces

### Rust modules

- `lib.rs` — Tauri builder, plugin registration, close-to-tray setup
- `tray.rs` — system tray menu and click handlers
- `scheduler.rs` — background reminder polling + notification dispatch
- `db.rs` — migration definitions

## Key Details

- UI language is Chinese (zh-CN)
- Recurring events: completing one auto-generates the next occurrence
- No IPC commands defined — frontend talks to SQLite directly via the sql plugin's JS API
- Capabilities are in `src-tauri/capabilities/default.json`
- Tauri plugins config is intentionally empty in `tauri.conf.json` (`"plugins": {}`) — sql preload is configured in Rust
- `event_time` is stored as UTC ISO strings; the "today" filter converts local midnight to ISO for comparison
- UUIDs are generated in the frontend via `crypto.randomUUID()` (the `uuid` crate in Cargo.toml is unused)
- `tauri-plugin-store` is registered but not currently used by any frontend code
